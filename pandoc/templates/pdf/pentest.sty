% Estilo de Tesis de la Universidad Tcnica Federico Santa Mara
% Departamento de Informtica.
% Valparaso, Chile
%
% Modificado por Roberto Bonvallet, 2010.
%  * Correcciones de estilo y ortografa
%
% Modificado por Romina Torres y Rodrigo Salas Fuentes 
% 2002.
%
% Modificado de:
%-%  Dalhousie University thesis style
%-%  Dept. of Math. Stats. and Comp. Sci.
%
% Modificado de:
%
%-% Stanford University PhD thesis style -- modifications to the report style
%-% For LaTeX version 2.09
%-% Last edit Tue Sep 13 14:40:26 1988
%-% Last edit by Joseph Pallas

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{pentest}
\typeout{Tesis Info Style}
\RequirePackage{ifthen}
\RequirePackage[spanish]{babel}
\RequirePackage[printwatermark]{xwatermark}
\RequirePackage[utf8]{inputenc}
\RequirePackage{latexsym}
\RequirePackage{tabularx}
\RequirePackage{times}
\RequirePackage{url}
\RequirePackage{graphicx}
\RequirePackage{xcolor}
\RequirePackage{xargs} % Use more than one optional parameter in a new commands
% 

\RequirePackage{listings}
% \RequirePackage{minted}


\lstdefinelanguage{myascii}
{
  morestring=[b]",
  morestring=[s]{>}{<},
  morecomment=[s]{<?}{?>},
  morekeywords={xmlns,version,type}% list your attributes here
}
\lstdefinestyle{mystyle}{
    basicstyle=\linespread{0.8}\ttfamily\small,
    % backgroundcolor=\color{black!10},
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2,
    captionpos=b,
    breaklines=true,
    breakatwhitespace=true,
    breakautoindent=true,
    linewidth=\textwidth
}
\renewcommand{\lstlistingname}{Código Fuente}
\lstset{style=mystyle}

% Define la cabecera de la pgina para enumerarla solamente.
%\newcommand{\properpagestyle}{\pagestyle{myheadings}\markboth{}{}\markright{}}
\newcommand{\properpagestyle}{\pagestyle{plain}}

% Lo primero que se hace es ver si el reporte ha sido cargado. 
% Un error comn es tratar de usar suthesis como un documentstyle.
\@ifundefined{chapter}{%
    \@latexerr{La opcin de 'pentest' debera ser usado %
               con el estilo de documento 'report'}%
               {Usted debera leer la documentacin de pentest.}}{}

% Se necesita un margen de 1" excepto en la pgina de binding la cual es de 1 1/2"
% Las Tesis son por un lado, por lo tanto no nos preopcupamos por \evensidemargin
%\oddsidemargin 0.5in
%\evensidemargin 0in
\marginparwidth 40pt
\marginparsep 10pt
%\topmargin 0pt
\headsep .5in
%\textheight 8.1in
%\textwidth 6in
\hoffset        -1.0in  % Seteo a 0 el margen izquierdo
\oddsidemargin   4cm    % Margen izquierdo (pag. impar)
%\oddsidemargin     0cm  % Ancho Legal 21,59cm
\evensidemargin  0.5cm  % Alto  Legal 35,56cm
\textwidth      15.5cm
\topmargin      -1.5cm
%\voffset           2cm  % Margen superior
\textheight       22cm
%\parindent      0em
%\parskip        2ex

% No permitir salto de pginas en hyphens (Esto dar algunos underfull vbox's,
% entonces una alternativa es usar \brokenpenalty=100 y manualmente buscar por
% y arreglar tales saltos de pginas.)
\brokenpenalty=10000

% Usar 1.37 veces el salto baseline-to-baseline normal 
\renewcommand{\baselinestretch}{1.37}

% Redefinir los macors utilizados para flotantes (incluyendo tablas y figuras)
% de manera tal que se usa un espaciamiento simple.
% (Notar que \def\figure{\@float{figure}set single spacing} no funciona
%  porque la figura tiene un argumento opcional.)
%
%\def\@xfloat#1[#2]{\ifhmode \@bsphack\@floatpenalty -\@Mii\else
%   \@floatpenalty-\@Miii\fi\def\@captype{#1}\ifinner
%      \@parmoderr\@floatpenalty\z@
%    \else\@next\@currbox\@freelist{\@tempcnta\csname ftype@#1\endcsname
%       \multiply\@tempcnta\@xxxii\advance\@tempcnta\sixt@@n
%       \@tfor \@tempa :=#2\do
%            {\if\@tempa h\advance\@tempcnta \@ne\fi
%             \if\@tempa t\advance\@tempcnta \tw@\fi
%             \if\@tempa b\advance\@tempcnta 4\relax\fi
%             \if\@tempa p\advance\@tempcnta 8\relax\fi
%     }\global\count\@currbox\@tempcnta}\@fltovf\fi
%    \global\setbox\@currbox\vbox\bgroup 
%    \def\baselinestretch{1}\@normalsize
%    \boxmaxdepth\z@
%    \hsize\columnwidth \@parboxrestore}

% Redefinir los macros utilizados para los pie de pginas para usar espaciamiento simple.
\long\def\@footnotetext#1{%
    \insert\footins{%
        \def\baselinestretch{1}\footnotesize
        \interlinepenalty\interfootnotelinepenalty 
        \splittopskip\footnotesep
        \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
        \hsize\columnwidth \@parboxrestore
        \edef\@currentlabel{\csname p@footnote\endcsname\@thefnmark}\@makefntext
        {\rule{\z@}{\footnotesep}\ignorespaces#1\strut}%
    }%
}

%\long\def\@makecaption#1#2{%
%  \vskip\abovecaptionskip
%  \sbox\@tempboxa{{\small \textbf{#1}: #2}}%
%  \ifdim \wd\@tempboxa >\hsize
%    {\small \textbf{#1}: #2}\par
%  \else
%    \global \@minipagefalse
%    \hb@xt@\hsize{\hfil\box\@tempboxa\hfil}%
%  \fi
%  \vskip\belowcaptionskip}

% \author, \title son definidos en el reporte; aqus est el resto de los
% front que definen macros.
\def\subtitle#1{\gdef\@subtitle{#1}}
\def\company#1{\gdef\@company{#1}}
\def\address#1{\gdef\@address{#1}}
\def\dept#1{\gdef\@dept{#1}}
\def\faculty#1{\gdef\@faculty{#1}}
\def\profguia#1{\gdef\@profguia{#1}}
\def\profcorr#1{\gdef\@profcorr{#1}}
\def\profext#1{\gdef\@profext{#1}}
\def\twosupervisors{\two@supervisorstrue}
\def\submitdate#1{\gdef\@submitdate{#1}}
\def\copyrightyear#1{\gdef\@copyrightyear{#1}}
\def\degree#1{\gdef\@degree{#1}}
\def\degreeinitial#1{\gdef\@degreeinitial{#1}}
\def\msc{\degree{Master of Science}\degreeinitial{M.Sc.}}
\def\phd{\degree{Doctor of Philosophy}\degreeinitial{Ph.D.}\ph@dtrue}
\def\ma{\degree{Master of Arts}\degreeinitial{M.A.}}
\def\ingej{\degree{Ingeniero en Ejecuci\'on}\degreeinitial{Ing.Ej.}}
\def\ingciv{\degree{Ingeniero Civil}\degreeinitial{Ing.Civ.}}
\ingciv % grado por defecto
\def\magister{\degree{Mag\'ister en Ciencias de la Ingenier\'ia Inform\'atica}\degreeinitial{Mg.}\ph@dtrue}
\def\doctor{\degre{Doctor}\degreeinitial{Dr.}\ph@dtrue}
\def\@title{}
\def\@author{}
\def\@company{Example Company Name}
\def\@subtitle{Example Subtitle}
\def\@profguia{}\def\@profcorr{}\def\@profext{}
\def\@submitdate{\ifcase\the\month\or
  Enero\or Febrero\or Marzo\or Abril\or Mayo\or Junio\or
  Julio\or Agosto\or Septiembre\or Octubre\or Noviembre\or Deciembre\fi
  \space \number\the\year}
\def\@copyrightyear{\number\the\year}

\def\convocation#1#2{\gdef\@convocationmonth{#1}\gdef\@convocationyear{#2}}
\def\@convwarn{\typeout{Alerta:  El dia de la convocatoria puede estar incorrecto!}}

\def\dedicate#1{\dedic@tiontrue\gdef\dedication@text{#1}}

\def\draft{\renewcommand{\properpagestyle}{\pagestyle{myheadings}
\markright{{\rm Versi\'on  Borrador -- \today}}}\draft@modetrue\properpagestyle}

\def\confidential{\confidential@modetrue}
\def\nobib{\print@bibfalse}
\def\nolistoffigures{\figurespagefalse}
\def\nolistoftables{\tablespagefalse}
\def\nofront{\front@pagesfalse\permissionfalse\figurespagefalse\tablespagefalse}

% New if constructs:    Default conditions:
\newif\ifpermission     \permissiontrue  
\newif\iffigurespage    \figurespagefalse
\newif\iftablespage     \tablespagefalse
\newif\iffront@pages    \front@pagestrue
\newif\ifthird@reader   \third@readerfalse
\newif\iffourth@reader  \fourth@readerfalse
\newif\iffifth@reader   \fifth@readerfalse
\newif\ifph@d           \ph@dfalse
\newif\iftwo@supervisors \two@supervisorsfalse
\newif\ifdraft@mode     \draft@modefalse
\newif\ifconfidential@mode     \confidential@modefalse
\newif\ifprint@bib      \print@bibtrue
\newif\ifdedic@tion     \dedic@tionfalse

\def\no@breaks#1{{\def\\{ \ignorespaces}#1}}    % disallow explicit line breaks

\def\titlep{
    \thispagestyle{empty}
    \hspace{-0.5cm}
    \begin{center}
        \begin{tabular}{c >{\centering\vspace{-1.7cm}}p{9.5cm} c}
            \includegraphics[width=65pt]{images/cskurity_logo} &
            \textsc{%
                \expandafter{\@company}} &
            \includegraphics[width=65pt]{images/utfsm}
        \end{tabular}
    \end{center}
    %\end{tabular}
    \ifdraft@mode
        \begin{center}
            \Large BORRADOR \\ \large Impreso el \today
        \end{center}
    \fi
    \ifconfidential@mode
        \newwatermark*[allpages,color=red!50,angle=45,scale=3,xpos=0,ypos=0]{CONFIDENTIAL}
    \fi
    \null\vskip1.2in
    \begin{center}
        \hyphenpenalty=10000\Large \textbf{\uppercase\expandafter{\@title}}
    \end{center}
    \vfill
    \begin{center}
        \rmfamily\Large
        %\expandafter{\@subtitle}
        % \\
        \textbf{\@author}
    \end{center}
    \vfill
    \begin{center}
        %Como requisito para optar al grado de:\\
        %\uppercase\expandafter{\@degree} \\

        %\uppercase\expandafter{\@company} \\
        %\uppercase\expandafter{\@address} \\
        \vskip0.3in       

        %\large \expandafter{\@profext} \\
        %\uppercase\expandafter{\@submitdate}
    \end{center}
    \vskip0.25in
    \begin{center}
        %\rm \copyright\ Derechos de \@author, \@copyrightyear
        \uppercase\expandafter{\@submitdate}
    \end{center}\newpage}

\def\signature#1#2{\parbox[b]{1in}{\smash{#1}\vskip12pt}
\hfill \parbox[t]{3in}{\shortstack{\vrule width 3in height 0.4pt\\\small#2}}}

    
\def\beforepreface{
\typeout{Most over/underfulls in first few pages are the fault of dalthesis.}
\typeout{Ignore all them.  If uncorrectable errors occur, notify staff.}
    \pagenumbering{roman}
    \pagestyle{plain}
    \titlep
    %\iffront@pages\signaturepage\else\addtocounter{page}{1}\fi
    %\ifpermission\permissionpage\else
    %\addtocounter{page}{1}
    %\fi
    \iffront@pages\ifdedic@tion
        \newpage \begin{flushright}
        \ \vskip5in
        \Large\em\null\vskip1in
        \dedication@text
        \end{flushright}
    \fi\fi

    \iffront@pages\tableofcontents\else\addtocounter{page}{1}\fi
    \newpage
    \iftablespage
        \addcontentsline{toc}{chapter}{Índice de Contenidos}\listoftables
        \newpage
    \fi
    \iffigurespage
        \addcontentsline{toc}{chapter}{Índice de Figuras}\listoffigures
        \newpage
    \fi
}
\def\nonumchapter#1{%
    \chapter*{#1}
    \addcontentsline{toc}{chapter}{#1}}

\def\prefacesection#1{%
    \chapter*{#1}
    \addcontentsline{toc}{chapter}{#1}}

\newenvironment{dedication}%
    {\newpage\begin{center}\Large\em\null\vskip1in}%
    {\vfill\end{center}}

\def\afterpreface{\newpage
    \pagenumbering{arabic}
    \pagestyle{plain}
    \typeout{Prefacio escrito.}
    \properpagestyle}

% Redefine \thebibliography para ir a una nueva pgina y colocar la entrada en la 
% tabla de contenidos
\let\@ldthebibliography\thebibliography
\renewcommand{\thebibliography}[1]{%
    \newpage
    \addcontentsline{toc}{chapter}{Bibliography}
    \@ldthebibliography{#1}
}

\let\@ldbibliography\bibliography
\renewcommand{\bibliography}[1]{\ifprint@bib\@ldbibliography{#1}\fi}

% Comenzar Normal.
\properpagestyle

% Use “\cite{NEEDED}” to get Wikipedia-style “citation needed” in document
\let\oldcite=\cite
\renewcommand\cite[1]{\ifthenelse{\equal{#1}{NEEDED}}{\ensuremath{^\texttt{[citation~needed]}}}{\oldcite{#1}}}
